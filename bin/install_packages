#!/usr/bin/bash

if test "$(whoami)" = "root"
then
    echo "This program should not be run as root."
    exit 1
fi

function ask() {
    echo ""
    echo -n "$1 [Y/n] "
    read input
    test "$input" = "Y"
}

sudo apt update

if ask "Install git?"; then
    sudo apt install -y git
fi

if ask "Install vim?"; then
    sudo apt install -y vim
fi

if ask "Install github:amix/vimrc? (Warning: Destructive!)"; then
    rm -rf ~/.vim_runtime
    git clone --depth=1 https://github.com/amix/vimrc.git ~/.vim_runtime
    ~/.vim_runtime/install_awesome_vimrc.sh
fi

if ask "Install tmux?"; then
    sudo apt install -y tmux
fi

if ask "Install Fish Shell?"; then
    echo 'deb http://download.opensuse.org/repositories/shells:/fish:/release:/3/Debian_11/ /' | sudo tee /etc/apt/sources.list.d/shells:fish:release:3.list
    curl -fsSL https://download.opensuse.org/repositories/shells:fish:release:3/Debian_11/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/shells_fish_release_3.gpg > /dev/null
    sudo apt update
    sudo apt install -y fish
    chsh --shell $(which fish)
fi

if ask "Install Homebrew?"; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# if ask "Update System Python?"; then
#     sudo add-apt-repository ppa:deadsnakes/ppa
#     sudo apt update
#     sudo apt install python3-pip python3.10-venv
#     sudo apt install python3.11 python3.11-venv python3-pip python-tk python3-tk tk-dev
#     sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 2
# fi

if ask "Install ruby-install?"; then
    brew install ruby-install
fi

if ask "Install chruby?"; then
    brew install chruby-fish
fi

if ask "Install pyenv?"; then
    sudo apt install -y python-tk python3-tk tk-dev
    brew install pyenv
fi

if ask "Install nvm?"; then
    mkdir -p $XDG_CONFIG_HOME/fish/plugins
    rm -rf $XDG_CONFIG_HOME/fish/plugins/nvm.fish
    git -C $XDG_CONFIG_HOME/fish/plugins clone git@github.com:jorgebucaran/nvm.fish.git
    fish -C "update_plugin nvm.fish"
    fish -C "emit nvm_install" # FIXME: This is supposed to install $nvm_data but doesn't
fi

if ask "Generate SSH Key?"; then
    ssh-keygen -t ed25519 -a 100 -C "$(whoami)@$(hostname)"
    ssh-keygen -y -f ~/.ssh/id_ed25519
fi

if ask "Install gcloud CLI?"; then
    sudo apt install -y apt-transport-https ca-certificates gnupg
    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo tee /usr/share/keyrings/cloud.google.gpg
    sudo apt update
    sudo apt install -y \
        google-cloud-cli \
        google-cloud-sdk \
        google-cloud-sdk-pubsub-emulator \
        google-cloud-sdk-cloud-run-proxy \
        google-cloud-sdk-app-engine-python \
        google-cloud-sdk-app-engine-python-extras

    gcloud init
fi

if ask "Install postgresql?"; then
    sudo apt install -y postgresql postgresql-contrib libpq-dev
fi

if ask "Install github CLI?"; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && sudo apt update \
    && sudo apt install gh -y
fi

if ask "Install xclip?"; then
    sudo apt install -y xclip
fi

if ask "Install ngrok?"; then
    curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
        sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && \
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
        sudo tee /etc/apt/sources.list.d/ngrok.list && \
        sudo apt update && \
        sudo apt install -y ngrok

    read -sp "Enter your ngrok auth token: " authtoken
    ngrok config add-authtoken $authtoken
fi

if ask "Install Insomnia?"; then
    curl -L -o /tmp/Insomnia-latest.deb "https://updates.insomnia.rest/downloads/ubuntu/latest?app=com.insomnia.app"
    sudo dpkg -i /tmp/Insomnia-latest.deb
fi

if ask "Install pgadmin?"; then
    curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg
    sudo sh -c 'echo "deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list'
    sudo apt update
    sudo apt install -y pgadmin4
fi

if ask "Install jq?"; then
    sudo apt install -y jq
fi

if ask "Install yq?"; then
    brew install -y yq
fi

# if ask "Update system node?"; then
#     curl -sL https://deb.nodesource.com/setup_18.x | sudo bash -
#     sudo apt install -y nodejs
# fi

if ask "Install terraform?"; then
    wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt update
    sudo apt install -y terraform
fi


if ask "Install dconf-editor?"; then
    sudo apt install -y dconf-editor
fi

if ask "Install flatpak?"; then
    sudo apt install -y flatpack
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
fi

if ask "Install Gnome Extension Manager?"; then
    flatpak install flathub com.mattjakeman.ExtensionManager
fi

# TODO:
# - apt default-jre
# - apt maven
# - swift
# - imwheel
# - xbindkeys?
# - bluez?
